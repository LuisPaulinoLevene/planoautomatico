<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background-image: url('fundo.jfif');
            background-size: cover;
            background-repeat: no-repeat;
        }

        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-image: url('fundo.jfif');
            border-radius: 5px;
            position: relative;
            padding: 0;
        }

        #chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #messages {
            flex: 1;
            overflow-y: scroll;
            padding: 10px;
            background-color: transparent;
        }

        .message {
            margin: 5px 0;
            padding: 10px;
            border-radius: 10px;
            max-width: 75%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            display: flex;
            flex-direction: column;
        }

        .sent {
            background-color: #dcf8c6;
            margin-left: auto;
            text-align: left;
        }

        .received {
            background-color: #ffffff;
            border: 1px solid #dedede;
            text-align: left;
        }

        .message-user {
            font-weight: bold;
            font-size: 0.9em;
        }

        .message-time,
        .message-date {
            font-size: 0.7em;
            color: gray;
            text-align: right;
            margin-top: 5px;
        }

        .input-container {
            display: flex;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #ccc;
            background-color: #fff;
        }

        textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            height: 40px;
        }

        .send-icon {
            width: 30px;
            height: 30px;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, orderBy, query, onSnapshot, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCjR7ByKvIFDoF61CL5u2SmYjZ2SOqGd4I",
            authDomain: "planoautomatico.firebaseapp.com",
            projectId: "planoautomatico",
            storageBucket: "planoautomatico.appspot.com",
            messagingSenderId: "474178177133",
            appId: "1:474178177133:web:452243accf7de0548b9764",
            measurementId: "G-7GZFKCREKH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message');
        const sendIcon = document.getElementById('send-icon');
        const displayedMessages = new Set(); // Para evitar mensagens duplicadas

        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "index.html";
            } else {
                updateMessages();
            }
        });

        function formatDate(timestamp) {
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        async function getUserName(email) {
            const userRef = collection(db, "users");
            const userQuery = query(userRef, where("email", "==", email));
            const userSnapshot = await getDocs(userQuery);

            if (!userSnapshot.empty) {
                const userDoc = userSnapshot.docs[0].data();
                return userDoc.name || email.split('@')[0];
            }
            return email.split('@')[0];
        }

        function updateMessages() {
            const messagesRef = collection(db, "messages");
            const q = query(messagesRef, orderBy("timestamp"));

            onSnapshot(q, async snapshot => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        const msgId = change.doc.id; // Obtém o ID do documento

                        // Verifica se a mensagem já foi exibida
                        if (!displayedMessages.has(msgId)) {
                            displayedMessages.add(msgId); // Marca a mensagem como exibida
                            if (msg.email && msg.text) {
                                const userName = await getUserName(msg.email);
                                const date = msg.timestamp ? formatDate(msg.timestamp) : '';
                                const time = msg.timestamp ? formatTime(msg.timestamp) : '';

                                // Cria o elemento de mensagem
                                const msgDiv = document.createElement('div');
                                msgDiv.className = `message ${msg.email === auth.currentUser.email ? 'sent' : 'received'}`;
                                msgDiv.innerHTML = `
                                    <div class="message-user">${userName}</div>
                                    <div>${msg.text}</div>
                                    <div class="message-time">${time}</div>
                                    <div class="message-date">${date}</div>
                                `;
                                messagesDiv.appendChild(msgDiv);
                            }
                        }
                    }
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // Rola para o final
            });
        }

        sendIcon.onclick = async () => {
            const message = messageInput.value.trim();
            const user = auth.currentUser;

            if (user && message) {
                const timestamp = { seconds: Math.floor(Date.now() / 1000) }; // Usando o horário atual
                const messageData = {
                    text: message,
                    email: user.email,
                    timestamp: timestamp,
                };

                // Envia a mensagem para o Firestore
                await addDoc(collection(db, "messages"), messageData);
                messageInput.value = ""; // Limpa a caixa de entrada
            }
        };
    </script>
</head>
<body>
    <div id="app">
        <div id="chat-section">
            <div id="messages"></div>
            <div class="input-container">
                <textarea id="message" placeholder="Digite sua mensagem"></textarea>
                <img id="send-icon" class="send-icon" src="send.jpg" alt="Enviar">
            </div>
        </div>
    </div>
</body>
</html>
